FROM node:18-slim as builder

ARG GH_NEXTAUTH_URL
ARG GH_NEXT_PUBLIC_SUBSTRATE_URL
ARG GH_NEXT_PUBLIC_SUBSTRATE_WSS
ARG GH_NEXT_PUBLIC_DATAHUB_QUERY_URL
ARG GH_NEXT_PUBLIC_DATAHUB_SUBSCRIPTION_URL
ARG GH_DATAHUB_QUEUE_URL
ARG GH_NEXT_PUBLIC_NOTIFICATION_APP_ID
ARG GH_NEXT_PUBLIC_OFFCHAIN_POSTING_HUBS
ARG GH_NEXT_PUBLIC_SPACE_IDS
ARG GH_NEXT_PUBLIC_AMP_ID
ARG GH_NEXT_PUBLIC_SQUID_URL
ARG GH_NEXT_PUBLIC_COMMUNITY_HUB_ID
ARG GH_NEXT_PUBLIC_GA_ID
ARG GH_NEXT_PUBLIC_APP_ID

ENV NEXTAUTH_URL=${GH_NEXTAUTH_URL} \
    NEXT_PUBLIC_SPACE_IDS=${GH_NEXT_PUBLIC_SPACE_IDS} \
    NEXT_PUBLIC_SUBSTRATE_WSS=${GH_NEXT_PUBLIC_SUBSTRATE_WSS} \
    NEXT_PUBLIC_SUBSTRATE_URL=${GH_NEXT_PUBLIC_SUBSTRATE_URL} \
    NEXT_PUBLIC_DATAHUB_QUERY_URL=${GH_NEXT_PUBLIC_DATAHUB_QUERY_URL} \
    NEXT_PUBLIC_DATAHUB_SUBSCRIPTION_URL=${GH_NEXT_PUBLIC_DATAHUB_SUBSCRIPTION_URL} \
    DATAHUB_QUEUE_URL=${GH_DATAHUB_QUEUE_URL} \
    NEXT_PUBLIC_APP_ID=${GH_NEXT_PUBLIC_APP_ID} \
    NEXT_PUBLIC_NOTIFICATION_APP_ID=${GH_NEXT_PUBLIC_NOTIFICATION_APP_ID} \
    NEXT_PUBLIC_OFFCHAIN_POSTING_HUBS=${GH_NEXT_PUBLIC_OFFCHAIN_POSTING_HUBS} \
    NEXT_PUBLIC_AMP_ID=${GH_NEXT_PUBLIC_AMP_ID} \
    NEXT_PUBLIC_SQUID_URL=${GH_NEXT_PUBLIC_SQUID_URL} \
    NEXT_PUBLIC_COMMUNITY_HUB_ID=${GH_NEXT_PUBLIC_COMMUNITY_HUB_ID} \
    NEXT_PUBLIC_GA_ID=${GH_NEXT_PUBLIC_GA_ID}


WORKDIR /opt/subsocial/app

COPY package.json yarn.lock* ./

RUN yarn install

COPY . .

RUN set -x \
    && mv ci.env .env \
    && yarn build

FROM gcr.io/distroless/nodejs:18 AS runner

ARG GH_NEXT_PUBLIC_SUBSTRATE_URL
ARG GH_NEXT_PUBLIC_SUBSTRATE_WSS
ARG GH_NEXT_PUBLIC_DATAHUB_QUERY_URL
ARG GH_NEXT_PUBLIC_DATAHUB_SUBSCRIPTION_URL
ARG GH_DATAHUB_QUEUE_URL
ARG GH_NEXT_PUBLIC_NOTIFICATION_APP_ID
ARG GH_NEXT_PUBLIC_OFFCHAIN_POSTING_HUBS
ARG GH_NEXT_PUBLIC_SPACE_IDS
ARG GH_NEXT_PUBLIC_AMP_ID
ARG GH_NEXT_PUBLIC_SQUID_URL
ARG GH_NEXT_PUBLIC_COMMUNITY_HUB_ID
ARG GH_NEXT_PUBLIC_GA_ID
ARG GH_NEXT_PUBLIC_APP_ID



ENV NEXTAUTH_URL=${GH_NEXTAUTH_URL} \
    NEXT_PUBLIC_SPACE_IDS=${GH_NEXT_PUBLIC_SPACE_IDS} \
    NEXT_PUBLIC_SUBSTRATE_WSS=${GH_NEXT_PUBLIC_SUBSTRATE_WSS} \
    NEXT_PUBLIC_SUBSTRATE_URL=${GH_NEXT_PUBLIC_SUBSTRATE_URL} \
    NEXT_PUBLIC_DATAHUB_QUERY_URL=${GH_NEXT_PUBLIC_DATAHUB_QUERY_URL} \
    NEXT_PUBLIC_DATAHUB_SUBSCRIPTION_URL=${GH_NEXT_PUBLIC_DATAHUB_SUBSCRIPTION_URL} \
    DATAHUB_QUEUE_URL=${GH_DATAHUB_QUEUE_URL} \
    NEXT_PUBLIC_APP_ID=${GH_NEXT_PUBLIC_APP_ID} \
    NEXT_PUBLIC_NOTIFICATION_APP_ID=${GH_NEXT_PUBLIC_NOTIFICATION_APP_ID} \
    NEXT_PUBLIC_OFFCHAIN_POSTING_HUBS=${GH_NEXT_PUBLIC_OFFCHAIN_POSTING_HUBS} \
    NEXT_PUBLIC_AMP_ID=${GH_NEXT_PUBLIC_AMP_ID} \
    NEXT_PUBLIC_SQUID_URL=${GH_NEXT_PUBLIC_SQUID_URL} \
    NEXT_PUBLIC_COMMUNITY_HUB_ID=${GH_NEXT_PUBLIC_COMMUNITY_HUB_ID} \
    NEXT_PUBLIC_GA_ID=${GH_NEXT_PUBLIC_GA_ID}

WORKDIR /opt/subsocial/app

COPY --from=builder /opt/subsocial/app .

CMD [ "/opt/subsocial/app/node_modules/.bin/next", "start" ]
